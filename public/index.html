<!DOCTYPE html>
<html>
<head>
    <title>Careless-Whisper - RTT Surveillance</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Careless Whisper</h1>
            <p>RTT Surveillance & Device Monitoring Tool</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="setup">üè† Setup</button>
            <button class="tab-btn" data-tab="analytics">üìà Analytics & Logs</button>
        </div>

        <!-- Tab: Setup -->
        <div class="tab-content active" id="tab-setup">
            <div class="grid">
                <div class="card">
                    <h2>üì± Platform Connection</h2>
                    
                    <!-- Platform Selector -->
                    <div class="platform-selector">
                        <div class="platform-option selected" data-platform="whatsapp">
                            <div class="icon">üí¨</div>
                            <div class="name">WhatsApp</div>
                            <div class="status">Available</div>
                        </div>
                        <div class="platform-option disabled" data-platform="signal">
                            <div class="icon">üîê</div>
                            <div class="name">Signal</div>
                            <div class="status">Coming Soon</div>
                        </div>
                    </div>

                    <div id="connection-status">
                        <p style="margin-bottom: 12px;">Status: <span class="status-badge status-disconnected" id="conn-badge">Disconnected</span></p>
                        <div class="qr-container" id="qr-container" style="display:none;">
                            <p style="color:#667eea;margin-bottom:12px;font-weight:600;">Scan QR Code to Connect</p>
                            <canvas id="qrcode"></canvas>
                        </div>
                        <div id="user-info" style="display:none;">
                            <div class="device-info">
                                <p><strong>Phone:</strong> <span id="user-phone">-</span></p>
                                <p><strong>Name:</strong> <span id="user-name">-</span></p>
                            </div>
                            <button class="btn btn-danger" id="logout-btn" style="margin-top:12px;">
                                <span>üö™</span> Logout
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>‚öôÔ∏è Configuration</h2>
                    <div class="form-group">
                        <label>Target Phone Number</label>
                        <input type="tel" id="target-number" placeholder="962XXXXXXXXX" />
                        <div class="form-help">Enter in international format without + or 00</div>
                    </div>
                    <div class="form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" id="duration" value="10" min="1" max="120" />
                        <div class="form-help">How long to monitor the target</div>
                    </div>
                    <div class="form-group">
                        <label>Probe Interval (seconds)</label>
                        <input type="number" id="interval" value="15" min="0.5" max="60" step="0.5" />
                        <div class="form-help warning">‚ö†Ô∏è Values below 5s increase ban risk</div>
                    </div>
                    <button class="btn btn-primary" id="start-btn" disabled>
                        <span>‚ñ∂</span> Start Monitoring
                    </button>
                    <button class="btn btn-danger" id="stop-btn" disabled style="margin-top:12px;">
                        <span>‚èπ</span> Stop Monitoring
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Analytics & Logs -->
        <div class="tab-content" id="tab-analytics">
            <div class="grid">
                <div class="card">
                    <h2>üìä Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="stat-probes">0</div>
                            <div class="stat-label">Total Probes</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-avg-rtt">-</div>
                            <div class="stat-label">Avg RTT (ms)</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-foreground">0</div>
                            <div class="stat-label">Foreground</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-screen-on">0</div>
                            <div class="stat-label">Screen On</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-screen-off">0</div>
                            <div class="stat-label">Screen Off</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-offline">0</div>
                            <div class="stat-label">Offline</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="clear-btn" style="margin-top:20px;">
                        <span>üóëÔ∏è</span> Clear Data
                    </button>
                </div>

                <div class="card">
                    <h2>üìù System Logs</h2>
                    <div class="log-container" id="log-container">
                        <div class="log-entry">
                            <span class="log-time">--:--:--</span>
                            <span>Waiting to start...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h2>üìà RTT Timeline</h2>
                <div class="chart-container">
                    <canvas id="rtt-chart"></canvas>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;" id="device-profile-card" style="display:none;">
                <h2>üîç Device Profile</h2>
                <div id="device-profile-content"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let rttChart;
        let selectedPlatform = 'whatsapp';
        let statsData = {
            probes: 0,
            avgRtt: 0,
            foreground: 0,
            screenOn: 0,
            screenOff: 0,
            offline: 0
        };

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');
            });
        });

        // Platform selection
        document.querySelectorAll('.platform-option').forEach(option => {
            option.addEventListener('click', () => {
                if (option.classList.contains('disabled')) return;
                
                document.querySelectorAll('.platform-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedPlatform = option.dataset.platform;
            });
        });

        // Initialize Chart
        const ctx = document.getElementById('rtt-chart').getContext('2d');
        rttChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'App Foreground',
                    data: [],
                    backgroundColor: '#10b981',
                    borderColor: '#10b981',
                    pointRadius: 5
                }, {
                    label: 'Screen On',
                    data: [],
                    backgroundColor: '#f59e0b',
                    borderColor: '#f59e0b',
                    pointRadius: 5
                }, {
                    label: 'Screen Off',
                    data: [],
                    backgroundColor: '#ef4444',
                    borderColor: '#ef4444',
                    pointRadius: 5
                }, {
                    label: 'Offline',
                    data: [],
                    backgroundColor: '#6b7280',
                    borderColor: '#6b7280',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true,
                        title: { display: true, text: 'RTT (ms)', color: '#495057' },
                        ticks: { color: '#495057' },
                        grid: { color: '#e8eef5' }
                    },
                    x: { 
                        type: 'linear',
                        title: { display: true, text: 'Probe #', color: '#495057' },
                        ticks: { color: '#495057' },
                        grid: { color: '#e8eef5' }
                    }
                },
                plugins: {
                    legend: { 
                        labels: { color: '#495057', font: { size: 12, weight: 600 } } 
                    }
                }
            }
        });

        // Socket event handlers
        let isConnected = false;
        
        socket.on('qr', (qrData) => {
            // Only show QR if not already connected
            if (!isConnected) {
                document.getElementById('qr-container').style.display = 'block';
                document.getElementById('user-info').style.display = 'none';
                const canvas = document.getElementById('qrcode');
                QRCode.toCanvas(canvas, qrData, { width: 256 });
                addLog('QR code generated - scan with WhatsApp');
            }
        });

        socket.on('connected', (user) => {
            isConnected = true;
            document.getElementById('conn-badge').textContent = 'Connected';
            document.getElementById('conn-badge').className = 'status-badge status-connected';
            document.getElementById('qr-container').style.display = 'none';
            document.getElementById('user-info').style.display = 'block';
            document.getElementById('user-phone').textContent = user.id;
            document.getElementById('user-name').textContent = user.name || 'N/A';
            document.getElementById('start-btn').disabled = false;
            addLog('WhatsApp connected successfully');
        });

        socket.on('disconnected', () => {
            document.getElementById('conn-badge').textContent = 'Disconnected';
            document.getElementById('conn-badge').className = 'status-badge status-disconnected';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('qr-container').style.display = 'none';
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = true;
            addLog('WhatsApp disconnected');
        });

        socket.on('measurement', (data) => {
            updateChart(data);
            addLog(`RTT: ${data.rtt_ms}ms | Status: ${data.status}`);
            socket.emit('get-stats');
        });

        socket.on('stats', (stats) => {
            // Update stats display
            statsData.probes = stats.total_measurements || 0;
            statsData.avgRtt = stats.avg_rtt ? Math.round(stats.avg_rtt) : 0;
            statsData.foreground = stats.status_counts?.APP_FOREGROUND || 0;
            statsData.screenOn = stats.status_counts?.SCREEN_ON || 0;
            statsData.screenOff = stats.status_counts?.SCREEN_OFF || 0;
            statsData.offline = stats.status_counts?.OFFLINE || 0;
            
            document.getElementById('stat-probes').textContent = statsData.probes;
            document.getElementById('stat-avg-rtt').textContent = statsData.avgRtt || '-';
            document.getElementById('stat-foreground').textContent = statsData.foreground;
            document.getElementById('stat-screen-on').textContent = statsData.screenOn;
            document.getElementById('stat-screen-off').textContent = statsData.screenOff;
            document.getElementById('stat-offline').textContent = statsData.offline;
        });

        socket.on('device-profile', (profile) => {
            const card = document.getElementById('device-profile-card');
            const content = document.getElementById('device-profile-content');
            
            if (profile) {
                card.style.display = 'block';
                content.innerHTML = `
                    <div class="device-info">
                        <p><strong>Device Type:</strong> <span>${profile.device_type || 'Unknown'}</span></p>
                        <p><strong>Brand:</strong> <span>${profile.brand || 'Unknown'}</span></p>
                        <p><strong>RTT Variance:</strong> <span>${profile.rtt_variance ? Math.round(profile.rtt_variance) + 'ms' : '-'}</span></p>
                        <p><strong>Confidence:</strong> <span>${profile.confidence ? Math.round(profile.confidence * 100) + '%' : '-'}</span></p>
                    </div>
                `;
            }
        });

        socket.on('log', (message) => {
            addLog(message);
        });

        document.getElementById('start-btn').addEventListener('click', () => {
            const config = {
                targetNumber: document.getElementById('target-number').value,
                deviceModel: 'Unknown',
                duration: parseInt(document.getElementById('duration').value),
                interval: parseFloat(document.getElementById('interval').value)
            };
            socket.emit('start-monitoring', config);
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            addLog(`Starting attack on: ${config.targetNumber}`);
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            socket.emit('stop-monitoring');
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            if (confirm('Clear all monitoring data?')) {
                socket.emit('clear-results');
                rttChart.data.datasets.forEach(d => d.data = []);
                rttChart.update();
                
                // Reset stats
                statsData = { probes: 0, avgRtt: 0, foreground: 0, screenOn: 0, screenOff: 0, offline: 0 };
                document.getElementById('stat-probes').textContent = '0';
                document.getElementById('stat-avg-rtt').textContent = '-';
                document.getElementById('stat-foreground').textContent = '0';
                document.getElementById('stat-screen-on').textContent = '0';
                document.getElementById('stat-screen-off').textContent = '0';
                document.getElementById('stat-offline').textContent = '0';
                
                addLog('All data cleared');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout? You will need to scan QR code again.')) {
                socket.emit('logout');
                addLog('Logging out...');
            }
        });

        function updateChart(data) {
            const probeNum = rttChart.data.datasets.reduce((sum, d) => sum + d.data.length, 0) + 1;
            const point = { x: probeNum, y: data.rtt_ms || 10000 };
            
            const idx = 
                data.status === 'APP_FOREGROUND' ? 0 :
                data.status === 'SCREEN_ON' ? 1 :
                data.status === 'SCREEN_OFF' ? 2 : 3;
            
            rttChart.data.datasets[idx].data.push(point);
            if (rttChart.data.datasets[idx].data.length > 50) {
                rttChart.data.datasets[idx].data.shift();
            }
            rttChart.update();
        }

        function addLog(message) {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="log-time">${time}</span><span>${message}</span>`;
            container.insertBefore(entry, container.firstChild);
            
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        // Initialize - check connection status on load
        socket.emit('get-status');
    </script>
</body>
</html>
